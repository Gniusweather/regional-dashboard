<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CAR/VEN METAR AND TAF</title>

  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #101820;
      color: #f2f2f2;
      margin: 0;
      padding: 24px;
      font-size: 1.6rem;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }

    button {
      display: block;
      margin: 0.5rem auto;
      font-family: monospace;
      font-size: 1.2rem;
      background: #004466;
      color: #fff;
      border: 1px solid #66ffcc;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #006699;
    }

    #timers {
      text-align: center;
      font-family: monospace;
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }
    #timers span { margin: 0 0.5rem; }
    #current-date, #local-time, #utc-time {
      color: #66ffcc;
      font-weight: bold;
    }
    #next-update { color: #999; font-size: 1.4rem; }

    .table-wrapper { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: monospace;
      font-size: 1.8rem;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 12px;
      border: 1px solid #2a3b47;
      vertical-align: top;
      text-align: center;
    }
    th {
      background: #003b5a;
      color: #66ffcc;
      font-size: 1.8rem;
    }
    td.station-code {
      font-size: 2.4rem;
      color: #66ffcc;
    }
    td.station-code.alert {
      background: #660000;
      color: #ffcccc;
    }
    td.low-vis, td.gust { color: #66ffcc; }
    td.wx, td.clouds { white-space: nowrap; }
    td.time-updated {
      background: #20c997;
      color: #ffffff;
      font-weight: bold;
      transition: background 0.3s ease, color 0.3s ease;
    }
    td.time-highlight {
      background: #006600;
      color: #ffffff;
      font-weight: bold;
    }
    .dimmed {
      opacity: 0.4;
      transition: opacity 0.3s;
    }

    /* flash animation for new data */
    @keyframes flash {
      0% { box-shadow: 0 0 0 0 rgba(102,255,204,0.9); }
      60% { box-shadow: 0 0 14px 6px rgba(102,255,204,0.18); }
      100% { box-shadow: 0 0 0 0 rgba(102,255,204,0); }
    }
    .new-data {
      animation: flash 1.2s ease-out;
    }

    .raw-row td {
      background: #1a2a33;
      font-size: 1.2rem;
      color: #cccccc;
      text-align: left;
      padding: 8px 12px;
    }
    .raw-current { margin-bottom: 4px; }
    .raw-row details summary {
      font-weight: bold;
      cursor: pointer;
    }
    .raw-row ul {
      list-style: disc inside;
      margin: 4px 0 0 16px;
      padding: 0;
    }

    #pressure-converter {
      text-align: center;
      font-family: monospace;
      font-size: 1.2rem;
      margin: 1rem auto;
    }
    #pressure-converter input {
      width: 80px;
      padding: 4px 6px;
      font-size: 1.2rem;
      text-align: right;
      border: 1px solid #66ffcc;
      border-radius: 4px;
      background: #101820;
      color: #f2f2f2;
    }
    #pressure-output {
      margin-left: 0.5rem;
      font-size: 1.2rem;
      color: #ffff99;
    }

    #bonaire-visibility {
      text-align: center;
      font-family: monospace;
      margin-bottom: 1rem;
      color: #66ffcc;
      font-size: 1.4rem;
    }

    #compact-taf {
      margin-top: 1rem;
      font-family: monospace;
      font-size: 1.4rem;
      line-height: 1.4;
      border-top: 1px solid #2a3b47;
      padding-top: 8px;
      max-height: 15rem;
      overflow-y: auto;
    }
    #compact-taf div { margin-bottom: 0.4rem; }
    #compact-taf strong {
      display: inline-block;
      width: 60px;
      color: #66ffcc;
      font-size: 1.4rem;
    }

    @media (max-width: 768px) {
      body { font-size: 1.2rem; padding: 12px; }
      h1 { font-size: 1.6rem; }
      button { font-size: 1rem; padding: 6px 12px; }
      #timers { font-size: 1.4rem; }
      table, th, td { font-size: 1.2rem; padding: 8px; }
      td.station-code { font-size: 1.8rem; }
      #pressure-converter input { width: 60px; font-size: 1rem; }
      #compact-taf strong {
        width: auto;
        display: block;
        margin-bottom: 4px;
      }
      #compact-taf span { display: block; font-size: 1.2rem; }
    }

    @media (max-width: 480px) {
      th:nth-child(3), td:nth-child(3),
      th:nth-child(5), td:nth-child(5),
      th:nth-child(6), td:nth-child(6),
      th:nth-child(8), td:nth-child(8) {
        display: none;
      }
      table { font-size: 1rem; }
      button { width: 100%; }
    }

    /* Mobile card‐style table for narrow screens */
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr {
        border: 1px solid #2a3b47;
        border-radius: 4px;
        margin-bottom: 1rem;
        padding: 8px;
      }
      td {
        display: flex;
        justify-content: space-between;
        padding: 8px;
      }
      td:before {
        font-weight: bold;
        color: #66ffcc;
        margin-right: 0.5rem;
      }
      td:nth-of-type(1):before { content: "ICAO"; }
      td:nth-of-type(2):before { content: "Time"; }
      td:nth-of-type(3):before { content: "Wind"; }
      td:nth-of-type(4):before { content: "Vis"; }
      td:nth-of-type(5):before { content: "Wx"; }
      td:nth-of-type(6):before { content: "Clouds"; }
      td:nth-of-type(7):before { content: "Temp/Dew"; }
      td:nth-of-type(8):before { content: "QNH"; }
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 1rem;
      color: #66ffcc;
      font-family: 'Inter', sans-serif;
    }
    footer i {
      margin: 0 0.25rem;
      color: #f2f2f2;
    }
  </style>
</head>
<body>

  <button id="mode-toggle">Switch to Test Mode</button>
  <h1>CAR/VEN METAR AND TAF</h1>

  <div id="timers">
    <span id="current-date">Date: --/--/----</span> |
    <span id="local-time">Local: --:--:--</span> |
    <span id="utc-time">UTC: --:--:--</span> |
    <span id="next-update">Next in: --s</span>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ICAO</th>
          <th>Time</th>
          <th>Wind</th>
          <th>Vis</th>
          <th>Wx</th>
          <th>Clouds</th>
          <th>Temp/Dew</th>
          <th>QNH</th>
        </tr>
      </thead>
      <tbody id="data">
        <tr><td colspan="8">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <div id="pressure-converter">
    <label>Pressure (hPa):
      <input id="pressure-input" type="number" placeholder="1013">
    </label>
    <span id="pressure-output">-- inHg</span>
  </div>

  <div id="bonaire-visibility">Bonaire Visibility: –</div>
  <div id="compact-taf">Loading TAF…</div>

  <!-- Single beep audio (plays once when any station has updated after initial load) -->
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    // --- CONFIG ---
    const API_KEY       = 'fb135a94c0574db4b26082b70705b4af';
    const metarStations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA','TNCS'];
    const tafStations   = ['TNCB','TNCC'];
    let metarInterval   = 10; // seconds for polling; adjust as needed
    // ---------------

    let isLive   = true;
    let lastFetch = Date.now();
    const prevTimes = {};   // last time token per ICAO
    const prevRaw   = {};   // last full raw METAR per ICAO
    const histories = {};   // in-memory history of raw strings
    let initialLoad = true; // don't beep on first successful population

    const modeToggleEl = document.getElementById('mode-toggle');
    const dataEl       = document.getElementById('data');
    const visEl        = document.getElementById('bonaire-visibility');
    const tafEl        = document.getElementById('compact-taf');
    const dateEl       = document.getElementById('current-date');
    const localTimeEl  = document.getElementById('local-time');
    const utcTimeEl    = document.getElementById('utc-time');
    const nextUpdateEl = document.getElementById('next-update');
    const pInput       = document.getElementById('pressure-input');
    const pOutput      = document.getElementById('pressure-output');
    const beepEl       = document.getElementById('beep');

    const pad = n => n.toString().padStart(2, '0');

    modeToggleEl.addEventListener('click', () => {
      isLive = !isLive;
      modeToggleEl.textContent = isLive
        ? 'Switch to Test Mode'
        : 'Switch to Live Mode';
      updateAll();
    });

    function updateClocks() {
      const now = new Date();
      dateEl.textContent      = `Date: ${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()}`;
      localTimeEl.textContent = `Local: ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      utcTimeEl.textContent   = `UTC: ${pad(now.getUTCHours())}:${pad(now.getUTCMinutes())}:${pad(now.getUTCSeconds())}`;
      const elapsed = Math.floor((Date.now() - lastFetch) / 1000);
      nextUpdateEl.textContent = `Next in: ${Math.max(metarInterval - elapsed, 0)}s`;
    }

    async function updateMetar() {
      try {
        const rawList = isLive
          ? await fetch(`https://api.checkwx.com/metar/${metarStations.join(',')}`, {
              headers: { 'X-API-Key': API_KEY }
            }).then(r => {
              if (!r.ok) throw new Error('CheckWX response not OK: ' + r.status);
              return r.json();
            }).then(j => j.data || [])
          : [
              "TNCA 010300Z 04015G40KT 4500 +TSRA OVC020CB 20/18 Q1012",
              "TNCB 010200Z 03010KT 3000 -TSRA SCT///TCU 22/19 Q1011",
              "TNCC 012355Z 05012KT P6SM SCT020 24/22 Q1014",
              "TNCM 020450Z 12012KT 10000 -SHRA SCT025 26/22 Q1014",
              "SVMI 020500Z 08010KT 9000 VCSH SCT020 28/21 Q1015",
              "SVVA 020400Z 06008KT P6SM FEW013CB(NW)BKN016 FEW///CB 25/23 Q1013",
              "TNCS 020520Z 12005KT 5000 BR OVC010 24/22 Q1011"
            ];

        let html = '';
        const now             = new Date();
        const currentUTC_Hour = now.getUTCHours();
        const prevHour        = (currentUTC_Hour + 23) % 24;

        let anyNewRawThisCycle = false;

        rawList.forEach(raw => {
          const toks     = raw.split(' ');
          const code     = toks[0];
          const time     = toks[1] || '';
          const hrToken  = time && time.length >= 4 ? parseInt(time.slice(2, 4), 10) : null;
          const minToken = time && time.length >= 6 ? parseInt(time.slice(4, 6), 10) : null;

          // freshness logic (preserves your existing rules)
          let isFresh;
          if (code === 'TNCB') {
            isFresh = true;
          } else if (code === 'TNCC') {
            isFresh = hrToken === currentUTC_Hour ||
                      (hrToken === prevHour && minToken >= 55);
          } else {
            isFresh = hrToken >= currentUTC_Hour;
          }
          const dimClass = isFresh ? '' : 'dimmed';

          const timeHighlight = (code === 'TNCC' &&
                                 hrToken === prevHour &&
                                 minToken >= 55)
                              ? 'time-highlight' : '';

          // find QNH and other tokens
          const qIdx = toks.findIndex(tok => /^Q\d{4}$/.test(tok));
          const dataToks = qIdx >= 0 ? toks.slice(2, qIdx+1) : toks.slice(2);

          let wind = '–', vis = '–', td = '–', qnh = '–';
          const clouds = [], wx = [];

          dataToks.forEach(tok => {
            if (/^Q\d{4}$/.test(tok)) {
              const h = +tok.slice(1);
              qnh = `${h} – ${(h*0.02953).toFixed(2)}`;
            } else if (/KT$/.test(tok)) {
              wind = tok;
            } else if (/^\d{4}$/.test(tok)) {
              vis = tok;
            } else if (/^(?:\+|-)?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|VCSH|PL|GR|GS|UP|BR|TS|FU|DU|SA|HZ|PY|PO|SQ|FC|SS|DS|VA)$/.test(tok)) {
              wx.push(tok);
            } else if (/^(?:FEW|SCT|BKN|OVC)/.test(tok)) {
              const layerRegex = /(?:FEW|SCT|BKN|OVC)(?:\d{3}(?:TCU|CB)?|\/\/\/(?:TCU|CB)?)(?:\([^)]*\))?/g;
              const matches = tok.match(layerRegex);
              if (matches) matches.forEach(layer => clouds.push(layer));
            } else if (/^M?\d{2}\/M?\d{2}$/.test(tok)) {
              td = tok;
            }
          });

          const gustVal    = +(wind.match(/G(\d{2,3})/)?.[1]||0);
          const visVal     = /^\d+$/.test(vis) ? +vis : 9999;
          const lowVis     = visVal <= 5000;
          const gustAlert  = gustVal >= 35;
          const wxAlert    = wx.length > 0;
          const cloudAlert = clouds.some(c => /TCU|CB/.test(c));
          const alertOn    = lowVis || gustAlert || wxAlert || cloudAlert;

          // detect raw change vs previously stored raw
          const prevRawForCode = prevRaw[code];
          const isNewRaw = prevRawForCode === undefined ? false : (prevRawForCode !== raw);

          // mark that at least one station changed this cycle
          if (isNewRaw) anyNewRawThisCycle = true;

          // build HTML (add visual new-data marker if raw changed)
          const newDataClass = isNewRaw ? ' new-data time-updated' : '';
          html += `
            <tr class="${dimClass}">
              <td class="station-code ${alertOn ? 'alert' : ''}">${code}</td>
              <td class="${timeHighlight} ${newDataClass}">${time}</td>
              <td class="${gustAlert ? 'gust' : ''}">${wind}</td>
              <td class="${lowVis ? 'low-vis' : ''}">${vis}</td>
              <td class="wx ${wxAlert ? 'low-vis' : ''}">${wx.join(' ') || '–'}</td>
              <td class="clouds ${cloudAlert ? 'low-vis' : ''}">${clouds.join(' ') || '–'}</td>
              <td>${td}</td>
              <td>${qnh}</td>
            </tr>`;

          // histories
          histories[code] = histories[code] || [];
          if (!histories[code].length || histories[code].slice(-1)[0] !== raw) {
            histories[code].push(raw);
            if (histories[code].length > 8) histories[code].shift();
          }
          const past = histories[code].slice(0, -1);

          html += `
            <tr class="raw-row">
              <td colspan="8">
                <div class="raw-current">Raw: ${raw}</div>
                ${past.length
                  ? `<details><summary>Past METARs</summary><ul>${past
                      .map(r => `<li>${r}</li>`)
                      .join('')}</ul></details>`
                  : ''}
              </td>
            </tr>`;

          // update stored values after processing
          prevTimes[code] = time;
          prevRaw[code] = raw;
        });

        dataEl.innerHTML = html;
        lastFetch = Date.now();

        // If this is NOT the first successful population and any station changed, beep once
        if (!initialLoad && anyNewRawThisCycle) {
          try {
            beepEl.currentTime = 0;
            // play may be blocked until user interacts; catch and log
            beepEl.play().catch(e => console.warn('Beep play blocked:', e));
          } catch (e) {
            console.warn('Beep play error:', e);
          }
        }

        // After first successful update, mark initialLoad false
        initialLoad = false;

        // remove time-updated class after a brief delay so new-data flash ends
        document.querySelectorAll('td.time-updated').forEach(cell => {
          setTimeout(() => cell.classList.remove('time-updated'), 1500);
        });

      } catch (err) {
        console.error('METAR fetch error:', err);
        dataEl.innerHTML = `<tr><td colspan="8">⚠️ Error loading METAR — ${err.message || 'unknown'}</td></tr>`;
        lastFetch = Date.now();
        // keep initialLoad as-is so we still don't beep on first good load after errors
      }
    }

    async function updateBonaireVis() {
      let scrapedVis = '–';
      if (isLive) {
        try {
          const txt = await fetch(
            'https://api.allorigins.win/raw?url=' +
              encodeURIComponent('https://www.knmidc.org/weather/bonaire/?Current')
          ).then(r => r.text());
          const doc = new DOMParser().parseFromString(txt,'text/html');
          const row = Array.from(doc.querySelectorAll('tr'))
                        .find(tr => tr.textContent.includes('Visibility (m)'));
          if (row)
            scrapedVis = row.querySelectorAll('td')[1].textContent.trim() + 'm';
        } catch (e) {
          console.warn('Bonaire visibility fetch error:', e);
          scrapedVis = 'n/a';
        }
      } else {
        scrapedVis = 'test';
      }
      visEl.textContent = `Bonaire Visibility: ${scrapedVis}`;
      document.querySelectorAll('#data tr').forEach(tr => {
        if (tr.children[0]?.textContent === 'TNCS') {
          tr.children[3].textContent = scrapedVis;
        }
      });
    }

    async function updateTaf() {
      try {
        const list = isLive
          ? await fetch(`https://api.checkwx.com/taf/${tafStations.join(',')}`, {
              headers: { 'X-API-Key': API_KEY }
            }).then(r => {
              if (!r.ok) throw new Error('CheckWX TAF response not OK: ' + r.status);
              return r.json();
            }).then(j => j.data || [])
          : [
              'TNCB 010300Z 0106/0206 03008KT P6SM SCT025',
              'TNCC 010300Z 0106/0206 34010KT P6SM BKN020'
            ];
        tafEl.innerHTML = list.map(r => {
          const toks = r.split(' ');
          return `<div><strong>${toks[0]}</strong> <span>${toks[1]}</span> ${toks.slice(2).join(' ')}</div>`;
        }).join('');
      } catch (err) {
        console.warn('TAF fetch error:', err);
        tafEl.textContent = '⚠️ Error loading TAF';
      }
    }

    function updatePressure() {
      const hpa = parseFloat(pInput.value);
      pOutput.textContent = isNaN(hpa)
        ? '-- inHg'
        : (hpa * 0.02953).toFixed(2) + ' inHg';
    }

    function updateAll() {
      updateMetar();
      updateClocks();
      updateBonaireVis();
      updateTaf();
      updatePressure();
    }

    pInput.addEventListener('input', updatePressure);

    // Copy on double-click
    document.querySelector('.table-wrapper').addEventListener('dblclick', e => {
      const td = e.target.closest('td');
      if (!td) return;
      navigator.clipboard.writeText(td.textContent.trim()).catch(e => console.warn('Clipboard write failed:', e));
    });

    // initial run and timers
    updateAll();
    setInterval(updateClocks, 1000);
    setInterval(updateAll, metarInterval * 1000);

    // Keyboard shortcut to tweak polling interval (ctrl+up / ctrl+down)
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'ArrowUp') {
        metarInterval = Math.max(5, metarInterval - 5);
        console.info('Polling interval set to', metarInterval);
      } else if (e.ctrlKey && e.key === 'ArrowDown') {
        metarInterval = Math.min(120, metarInterval + 5);
        console.info('Polling interval set to', metarInterval);
      }
    });
  </script>

  <footer>
    Created by GNius. Powered by
    <i class="fas fa-robot"></i> Copilot and
    <i class="fab fa-github"></i> GitHub.
  </footer>

</body>
</html>
